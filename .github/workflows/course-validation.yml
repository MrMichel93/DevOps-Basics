name: Course Content Validation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  validate-structure:
    name: Validate Repository Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required directories exist
        run: |
          required_dirs=(
            "00-Setup"
            "01-Git-and-GitHub"
            "02-Command-Line-Mastery"
            "03-Docker-Fundamentals"
            "04-CI-CD-with-GitHub-Actions"
            "05-Infrastructure-as-Code-Lite"
            "06-Monitoring-and-Logging"
            "07-Security-Basics"
            "Projects"
            "Resources"
          )

          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "❌ Missing required directory: $dir"
              exit 1
            else
              echo "✅ Found directory: $dir"
            fi
          done

      - name: Check required files exist
        run: |
          required_files=(
            "README.md"
            "00-Setup/README.md"
            "01-Git-and-GitHub/README.md"
            "02-Command-Line-Mastery/README.md"
            "03-Docker-Fundamentals/README.md"
          )

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing required file: $file"
              exit 1
            else
              echo "✅ Found file: $file"
            fi
          done

      - name: Validate all README files have content
        run: |
          find . -name "README.md" -type f | while read -r file; do
            size=$(wc -c < "$file")
            if [ "$size" -lt 100 ]; then
              echo "❌ $file is too small (${size} bytes)"
              exit 1
            else
              echo "✅ $file has sufficient content (${size} bytes)"
            fi
          done

  check-links:
    name: Check Markdown Links
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check links in markdown files
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'no'
          config-file: '.github/markdown-link-check-config.json'
          check-modified-files-only: 'no'

  validate-examples:
    name: Validate Example Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Validate Python example syntax
        run: |
          find ./03-Docker-Fundamentals/examples -name "*.py" -type f | while read -r file; do
            echo "Checking $file"
            python -m py_compile "$file" || exit 1
          done

      - name: Validate Node.js example syntax
        run: |
          cd 03-Docker-Fundamentals/examples/nodejs-app
          npm install
          node -c server.js

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '0'  # Don't fail the build
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'
